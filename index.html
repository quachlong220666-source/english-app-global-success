<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiếng Anh Global Success App - No Bold Questions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Error Screen Style */
        #crash-screen { display: none; padding: 2rem; text-align: center; background: #fff0f0; height: 100vh; }
        .matrix-table th, .matrix-table td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; font-size: 0.85rem; }
        .matrix-table th { background-color: #005CA9; color: white; }
        .matrix-table .sub-header { background-color: #f1f5f9; font-weight: bold; color: #334155; }
        /* Preview Page Styles */
        .preview-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            font-family: 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1.3;
            color: black;
            overflow-wrap: break-word;
        }
        .preview-container {
            background: #525659;
            padding: 40px 0;
            height: 600px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body>
    <!-- Màn hình báo lỗi (Ẩn mặc định) -->
    <div id="crash-screen">
        <h1 style="color: #d32f2f; font-size: 24px; margin-bottom: 20px;">⚠️ Ứng dụng gặp sự cố</h1>
        <p style="margin-bottom: 20px;">Có thể dữ liệu cũ không tương thích với phiên bản mới.</p>
        <button onclick="hardReset()" style="background: #d32f2f; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
            BẤM VÀO ĐÂY ĐỂ SỬA LỖI NGAY
        </button>
        <p id="error-detail" style="margin-top: 20px; color: #666; font-size: 12px; font-family: monospace;"></p>
    </div>

    <div id="root"></div>

    <script>
        // Hàm sửa lỗi cứng
        function hardReset() {
            localStorage.clear();
            window.location.reload();
        }
        
        // Bắt lỗi toàn cục
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('crash-screen').style.display = 'block';
            document.getElementById('error-detail').innerText = msg;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Fragment } = React;

        // --- 1. DỮ LIỆU CỐ ĐỊNH (CONSTANTS) ---
        
        // Ma trận đề thi chuẩn
        const MATRIX_RULES = {
            '6-7-8': { 
                structure: [
                    { skill: 'Listening', total: 8, levels: { NB: 3, TH: 3, VD: 2, VDC: 0 } },
                    { skill: 'Reading', total: 8, levels: { NB: 3, TH: 3, VD: 1, VDC: 1 } },
                    { skill: 'Language', total: 16, levels: { NB: 8, TH: 5, VD: 3, VDC: 0 } },
                    { skill: 'Writing', total: 8, levels: { NB: 2, TH: 1, VD: 2, VDC: 3 } }
                ],
                totalQuestions: 40,
                description: "Thời gian 60 phút; Tỉ lệ 4-3-2-1"
            },
            '9': { 
                structure: [
                    { skill: 'Listening', total: 10, levels: { NB: 4, TH: 3, VD: 2, VDC: 1 } },
                    { skill: 'Reading', total: 10, levels: { NB: 4, TH: 3, VD: 2, VDC: 1 } },
                    { skill: 'Language', total: 20, levels: { NB: 8, TH: 6, VD: 4, VDC: 2 } }
                ],
                totalQuestions: 40,
                description: "Thời gian 60 phút; 100% Trắc nghiệm"
            }
        };

        const SAMPLE_READING_PASSAGE = {
            'Lớp 6': "My new school is in a quiet place not far from the city centre. It has three buildings and a large yard. This year there are 26 classes with more than 1,000 students. Most students are hard-working and serious. The school has about 40 teachers. They are all helpful and friendly.",
            'Lớp 7': "Healthy living is about making healthy choices every day. It’s about eating a balanced diet, getting regular exercise, and avoiding harmful habits. Eating plenty of fruits and vegetables is important. You should also drink enough water.",
            'Lớp 8': "If you go to the American state of Alaska, you might find the traditional lifestyle there interesting. Although Alaska is quite large, it has a small population. The native peoples in Alaska still maintain many of their traditions.",
            'Lớp 9': "Living in a city has both advantages and disadvantages. On the plus side, it is easier to find jobs and there are better schools. However, city life can be stressful. The cost of living is high, and the environment is often polluted."
        };

        // Dữ liệu dự phòng (Backup)
        const SAMPLE_QUESTIONS = {
            Listening: [
                { q: "What is the main idea of the talk?", options: ["A. City life", "B. School life", "C. Holidays", "D. Environment"] },
                { q: "When does the event start?", options: ["A. 7:00 a.m.", "B. 8:30 a.m.", "C. 9:00 a.m.", "D. 2:00 p.m."] },
                { q: "How does the speaker feel?", options: ["A. Happy", "B. Sad", "C. Worried", "D. Angry"] },
                { q: "Who is the speaker talking to?", options: ["A. Teacher", "B. Friend", "C. Parent", "D. Doctor"] }
            ],
            Reading: [
                { q: "What is the passage about?", options: ["A. Festival", "B. Landmark", "C. Routine", "D. Education"] },
                { q: "The word 'it' refers to:", options: ["A. School", "B. City", "C. Yard", "D. Student"] },
                { q: "Which statement is TRUE?", options: ["A. Statement A", "B. Statement B", "C. Statement C", "D. Statement D"] },
                { q: "Why does the author like it?", options: ["A. Reason A", "B. Reason B", "C. Reason C", "D. Reason D"] }
            ],
            Language: [
                { q: "Choose the word with different stress.", options: ["A. happy", "B. jealous", "C. prepare", "D. nervous"] },
                { q: "She is interested _____ music.", options: ["A. in", "B. on", "C. at", "D. with"] },
                { q: "He _____ football yesterday.", options: ["A. play", "B. plays", "C. played", "D. playing"] },
                { q: "This is the _____ book I have read.", options: ["A. good", "B. better", "C. best", "D. well"] }
            ],
            Writing: [
                 { q: "Rewrite: 'I don't have a car.'", options: ["A. I wish I had a car.", "B. I wish I have a car.", "C. I wish I will have a car.", "D. I wish a car."] }
            ]
        };
        
        // Ngân hàng câu hỏi Lớp 8 chi tiết
        const UNIT_QUESTION_BANK = {
            '8-1': [
                { q: "I love _____ with my friends in my free time.", options: ["A. hanging out", "B. hang out", "C. hanged out", "D. hanging up"] },
                { q: "Mai is interested in _____ DIY projects.", options: ["A. do", "B. doing", "C. to do", "D. did"] },
                { q: "Choose the word with different sound in the underlined part: school, moon, food, foot.", options: ["A. school", "B. moon", "C. food", "D. foot"] },
                { q: "She is fond of _____ clouds.", options: ["A. watch", "B. watching", "C. to watch", "D. watched"] },
                { q: "We usually _____ sheep in the pasture.", options: ["A. herd", "B. feed", "C. raise", "D. play"] }
            ],
            '8-2': [
                { q: "People in the countryside seem to live _____ than those in the city.", options: ["A. happy", "B. more happily", "C. happily", "D. happier"] },
                { q: "Combine harvesters help farmers _____ rice faster.", options: ["A. plant", "B. water", "C. harvest", "D. dry"] },
                { q: "It rained _____ yesterday than today.", options: ["A. heavy", "B. heavily", "C. more heavily", "D. most heavily"] },
                { q: "The scenery in my village is very _____.", options: ["A. picture", "B. pictures", "C. picturesque", "D. pictured"] }
            ],
            '8-3': [
                { q: "Teenagers often feel _____ due to school pressure.", options: ["A. happy", "B. relaxed", "C. stressed", "D. funny"] },
                { q: "We often use Facebook to _____ with friends.", options: ["A. connect", "B. meet", "C. see", "D. look"] },
                { q: "He studied hard; _____, he got good marks.", options: ["A. however", "B. therefore", "C. but", "D. so"] },
                { q: "You should browse the _____ to find info.", options: ["A. website", "B. account", "C. forum", "D. club"] }
            ],
             '8-4': [
                { q: "The Rong house is the _____ house of the village.", options: ["A. community", "B. communal", "C. common", "D. communication"] },
                { q: "Five-coloured sticky rice is a traditional _____ of the Tay.", options: ["A. dish", "B. costume", "C. instrument", "D. house"] },
                { q: "The Gong Festival is held _____ in the Central Highlands.", options: ["A. year", "B. yearly", "C. years", "D. a year"] }
            ],
            '8-5': [
                { q: "In Viet Nam, we often _____ our ancestors.", options: ["A. worship", "B. hope", "C. admire", "D. pray"] },
                { q: "It's the custom _____ lucky money at Tet.", options: ["A. give", "B. giving", "C. to give", "D. gave"] },
                { q: "We usually have a family _____ on New Year.", options: ["A. reunion", "B. union", "C. meeting", "D. collection"] }
            ],
            '8-6': [
                { q: "In the future, we _____ probably study online more.", options: ["A. will", "B. are", "C. do", "D. did"] },
                { q: "Street food is a popular _____ in Viet Nam.", options: ["A. lifestyle", "B. practice", "C. habit", "D. custom"] },
                { q: "The native people in Alaska use _____ for transport.", options: ["A. dogsleds", "B. cars", "C. trains", "D. bikes"] }
            ],
            '8-7': [
                { q: "We should protect _____ species.", options: ["A. dangerous", "B. endangered", "C. danger", "D. endanger"] },
                { q: "_____ products like plastic bags are bad.", options: ["A. Multi-use", "B. Single-use", "C. Reuse", "D. Useful"] },
                { q: "Reducing our carbon _____ is necessary.", options: ["A. finger", "B. footprint", "C. hand", "D. step"] }
            ],
            '8-8': [
                { q: "I often buy things at the _____ market.", options: ["A. open-air", "B. open-space", "C. open-minded", "D. open-door"] },
                { q: "The prices here are fixed, so you can't _____.", options: ["A. buy", "B. sell", "C. bargain", "D. pay"] },
                { q: "She is a _____. She shops all the time.", options: ["A. shopaholic", "B. shopper", "C. shop owner", "D. shop assistant"] }
            ],
            '8-9': [
                { q: "A _____ destroyed many houses last night.", options: ["A. flood", "B. rain", "C. water", "D. wind"] },
                { q: "The volcanic _____ caused damage.", options: ["A. erupt", "B. eruption", "C. erupting", "D. erupted"] },
                { q: "We prepare an _____ kit for disasters.", options: ["A. emergency", "B. urgent", "C. hurry", "D. quick"] }
            ]
        };

        const CURRICULUM_DATA = {
            'Lớp 6': [ { id: '6-1', title: 'Unit 1: My New School' }, { id: '6-2', title: 'Unit 2: My Home' }, { id: '6-3', title: 'Unit 3: My Friends' }, { id: '6-4', title: 'Unit 4: My Neighbourhood' } ],
            'Lớp 7': [ { id: '7-1', title: 'Unit 1: Hobbies' }, { id: '7-2', title: 'Unit 2: Healthy Living' }, { id: '7-3', title: 'Unit 3: Community Service' } ],
            'Lớp 8': [
                { id: '8-1', title: 'Unit 1: Leisure Time' }, { id: '8-2', title: 'Unit 2: Life in the Countryside' }, { id: '8-3', title: 'Unit 3: Teenagers' },
                { id: '8-4', title: 'Unit 4: Ethnic Groups' }, { id: '8-5', title: 'Unit 5: Customs and Traditions' }, { id: '8-6', title: 'Unit 6: Lifestyles' },
                { id: '8-7', title: 'Unit 7: Environmental Protection' }, { id: '8-8', title: 'Unit 8: Shopping' }, { id: '8-9', title: 'Unit 9: Natural Disasters' }
            ],
            'Lớp 9': [ { id: '9-1', title: 'Unit 1: Local Community' }, { id: '9-2', title: 'Unit 2: City Life' } ]
        };

        // --- ICONS (An toàn tuyệt đối) ---
        const Icon = ({ path }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                {path}
            </svg>
        );

        const Icons = {
            Info: <g><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></g>,
            BookOpen: <g><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></g>,
            Settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></g>,
            Grid3X3: <g><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></g>,
            Download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></g>,
            ChevronRight: <path d="m9 18 6-6-6-6"/>,
            ChevronLeft: <path d="m15 18-6-6 6-6"/>,
            CheckCircle2: <g><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></g>,
            Check: <path d="M20 6 9 17l-5-5"/>,
            Languages: <g><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></g>,
            Eye: <g><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></g>
        };

        // --- CORE GENERATOR FUNCTION (Dùng chung cho Preview và Export) ---
        const generateExamContent = (formData, selectedUnits, grade) => {
            const matrixKey = (grade === 'Lớp 9') ? '9' : '6-7-8';
            const matrix = MATRIX_RULES[matrixKey];
            
            let globalQuestionIndex = 1;
            const answerKeys = [];
            let htmlBody = `
                <div style="text-align:center; margin-bottom:12pt;">
                    <div style="font-weight:bold; font-size:14pt; text-transform:uppercase;">${formData.schoolName}</div>
                    <div style="font-weight:bold; font-size:13pt; text-transform:uppercase; margin-top:6pt;">ĐỀ KIỂM TRA TIẾNG ANH - ${formData.grade.toUpperCase()}</div>
                    <div style="margin-top:6pt;"><em>Kỳ thi: ${formData.examName} | Mã đề: ${formData.examNumber} | Thời gian: 60 phút</em></div>
                </div>
                
                <div style="font-weight:bold; text-align:center; margin-top:12pt; margin-bottom:6pt;">I. MA TRẬN ĐỀ KIỂM TRA (MATRIX)</div>
                <table border="1" style="width:100%; border-collapse:collapse; margin-bottom:12pt;">
                    <tr style="background:#f0f0f0; font-weight:bold; text-align:center;"><td>Kỹ năng</td><td>NB</td><td>TH</td><td>VD</td><td>VDC</td><td>Tổng</td></tr>
                    ${matrix.structure.map(row => `<tr><td style="text-align:left;">${row.skill}</td><td style="text-align:center;">${row.levels.NB||'-'}</td><td style="text-align:center;">${row.levels.TH||'-'}</td><td style="text-align:center;">${row.levels.VD||'-'}</td><td style="text-align:center;">${row.levels.VDC||'-'}</td><td style="text-align:center; font-weight:bold;">${row.total}</td></tr>`).join('')}
                </table>

                <div style="font-weight:bold; text-align:center; margin-top:18pt; margin-bottom:12pt;">II. NỘI DUNG ĐỀ KIỂM TRA</div>
            `;

            // Helper get questions
            const getQuestionData = (skill) => {
                let questions = [];
                if (grade === 'Lớp 8') {
                    selectedUnits.forEach(uid => {
                        if(UNIT_QUESTION_BANK[uid]) questions = [...questions, ...UNIT_QUESTION_BANK[uid]];
                    });
                    if (questions.length < 5) Object.keys(UNIT_QUESTION_BANK).forEach(k => { if(k.startsWith('8-')) questions.push(...UNIT_QUESTION_BANK[k]); });
                }
                if (questions.length === 0 || skill !== 'Language') {
                    questions = SAMPLE_QUESTIONS[skill] || SAMPLE_QUESTIONS['Language'];
                }
                return questions;
            };

            matrix.structure.forEach((row, idx) => {
                const sectionMap = { 'Listening': 'I. LISTENING', 'Reading': 'II. READING', 'Language': 'III. LANGUAGE', 'Writing': 'IV. WRITING' };
                const sectionTitle = sectionMap[row.skill] || `PART ${idx + 1}`;
                
                htmlBody += `<div style="font-weight:bold; margin-top:12pt; margin-bottom:6pt;">${sectionTitle}</div>`;
                
                if (row.skill === 'Reading') {
                    const passage = SAMPLE_READING_PASSAGE[formData.grade] || SAMPLE_READING_PASSAGE['Lớp 8'];
                    htmlBody += `<div style="border:1px solid #999; padding:8pt; margin-bottom:8pt; font-style:italic; text-align:justify;">${passage}</div>`;
                }
                if (row.skill === 'Listening') htmlBody += `<div style="font-style:italic; margin-bottom:8pt;">(Listen to the recording twice)</div>`;

                const questions = getQuestionData(row.skill);

                for(let i=0; i<row.total; i++) {
                    const currentQNum = globalQuestionIndex++;
                    const qData = questions[i % questions.length] || { q: "Sample Question", options: ["A", "B", "C", "D"] };
                    
                    let answer = 'A'; 
                    if (qData.options && qData.options.length > 0) {
                        const correctChar = ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)];
                        answer = correctChar;
                    }
                    
                    let ops = qData.options || ["A. Option A", "B. Option B", "C. Option C", "D. Option D"];

                    if (row.skill === 'Writing' && grade !== 'Lớp 9' && !qData.options) {
                        answer = "Student's answer";
                        htmlBody += `<div style="margin-bottom:8pt;">
                                    <div style="margin-bottom:4pt;">${currentQNum}. ${qData.q || qData}</div>
                                    <div style="margin-left:20pt; color:#555; font-style:italic;">_______________________________________________________</div>
                                </div>`;
                    } else {
                        htmlBody += `<div style="margin-bottom:8pt;">
                                <div style="margin-bottom:4pt;">${currentQNum}. ${qData.q || qData}</div>
                                <table style="width:100%; border:none; margin-left:15pt; margin-bottom:0;">
                                    <tr>
                                        <td style="border:none; width:25%; padding:0; vertical-align:top;">${ops[0]||'A.'}</td>
                                        <td style="border:none; width:25%; padding:0; vertical-align:top;">${ops[1]||'B.'}</td>
                                        <td style="border:none; width:25%; padding:0; vertical-align:top;">${ops[2]||'C.'}</td>
                                        <td style="border:none; width:25%; padding:0; vertical-align:top;">${ops[3]||'D.'}</td>
                                    </tr>
                                </table>
                            </div>`;
                    }
                    answerKeys.push({ q: currentQNum, ans: answer });
                }
            });

            htmlBody += `<div style="text-align:center; margin-top:18pt; font-style:italic;">--- THE END ---</div>`;
            
            // Answer Key HTML
            const answerKeyHtml = `
                <br clear=all style='mso-special-character:line-break;page-break-before:always'>
                <div style="text-align:center; font-weight:bold; font-size:14pt; margin-top:20pt; margin-bottom:12pt; border-top: 1px dashed #ccc; padding-top: 20px;">ĐÁP ÁN (ANSWER KEY) - MÃ ĐỀ ${formData.examNumber}</div>
                <table border="1" style="width:50%; margin:0 auto; border-collapse:collapse;">
                    <tr style="background:#e0e0e0; font-weight:bold; text-align:center;"><td>Câu</td><td>Đáp án</td></tr>
                    ${answerKeys.map(k => `<tr><td style="text-align:center;">${k.q}</td><td style="text-align:center; font-weight:bold;">${k.ans}</td></tr>`).join('')}
                </table>
            `;

            return { body: htmlBody, keys: answerKeyHtml };
        };


        // --- COMPONENTS ---
        const Header = () => (
            <header className="bg-[#005CA9] text-white py-4 px-6 shadow-md sticky top-0 z-50">
                <div className="max-w-7xl mx-auto flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm"><Icon path={Icons.Languages} /></div>
                        <div>
                            <h1 className="text-xl font-bold uppercase tracking-wide">TIẾNG ANH GLOBAL SUCCESS</h1>
                            <p className="text-xs text-blue-100 opacity-90 hidden sm:block">Hệ thống tạo đề chuẩn Ma trận BGD (v4.1 No Bold Q)</p>
                        </div>
                    </div>
                </div>
            </header>
        );

        // Các bước 1-4 giữ nguyên như cũ (tôi rút gọn để tập trung vào Preview)
        const Step1Info = ({ data, onChange }) => (
             <div className="max-w-3xl mx-auto mt-8 bg-white rounded-xl shadow-lg border p-8">
                <h2 className="text-xl font-bold mb-4 flex gap-2"><Icon path={Icons.Info}/> Thông tin chung</h2>
                <div className="space-y-4">
                     <input type="text" value={data.schoolName} onChange={e => onChange('schoolName', e.target.value)} className="w-full border p-2 rounded" placeholder="Tên trường..." />
                     <div className="grid grid-cols-2 gap-4">
                        <select value={data.grade} onChange={e => onChange('grade', e.target.value)} className="border p-2 rounded">{Object.keys(CURRICULUM_DATA).map(g=><option key={g}>{g}</option>)}</select>
                        <input type="text" value={data.year} onChange={e => onChange('year', e.target.value)} className="border p-2 rounded" />
                     </div>
                     <div className="grid grid-cols-2 gap-4">
                        <select value={data.examName} onChange={e => onChange('examName', e.target.value)} className="border p-2 rounded"><option>Kiểm tra Cuối kì I</option><option>Kiểm tra Giữa kì I</option></select>
                        <input type="number" value={data.examNumber} onChange={e => onChange('examNumber', e.target.value)} className="border p-2 rounded text-center" />
                     </div>
                </div>
             </div>
        );

        const Step2Topics = ({ grade, selectedUnits, onToggleUnit }) => {
            const units = CURRICULUM_DATA[grade] || [];
            return (
                <div className="max-w-4xl mx-auto mt-8 p-4">
                    <h2 className="text-2xl font-bold mb-4 flex gap-2"><Icon path={Icons.BookOpen}/> Phạm vi kiến thức</h2>
                    <div className="grid grid-cols-2 gap-4">
                        {units.map(unit => (
                            <div key={unit.id} onClick={() => onToggleUnit(unit.id)} className={`p-4 border rounded cursor-pointer flex justify-between ${selectedUnits.includes(unit.id)?'border-blue-500 bg-blue-50':''}`}>
                                <span>{unit.title}</span>
                                {selectedUnits.includes(unit.id) && <Icon path={Icons.CheckCircle2} className="text-blue-500"/>}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Step3Config = ({grade}) => (
            <div className="max-w-4xl mx-auto mt-8 p-4 text-center">
                 <h2 className="text-2xl font-bold mb-4">Cấu trúc Ma trận (Chuẩn BGD)</h2>
                 <p>Cấu trúc đã được cố định theo quy định chuyên môn cho {grade}.</p>
                 <div className="bg-gray-100 p-4 rounded mt-4">Không cần cấu hình thêm.</div>
            </div>
        );

        const Step4Matrix = ({grade}) => (
             <div className="max-w-4xl mx-auto mt-8 p-4 text-center">
                 <h2 className="text-2xl font-bold mb-4">Ma trận chi tiết</h2>
                 <p>Hệ thống sẽ tự động phân bổ câu hỏi theo ma trận {grade}.</p>
                 <div className="bg-green-50 p-4 rounded mt-4 border border-green-200">Đã sẵn sàng sinh đề!</div>
            </div>
        );

        // --- NEW STEP 5: PREVIEW ---
        const Step5Preview = ({ formData, selectedUnits, grade, onContentGenerated }) => {
            const [content, setContent] = useState({ body: '', keys: '' });

            useEffect(() => {
                // Tạo nội dung ngay khi component được mount
                const generated = generateExamContent(formData, selectedUnits, grade);
                setContent(generated);
                onContentGenerated(generated); // Gửi dữ liệu lên App để dùng cho bước Export
            }, []);

            return (
                <div className="max-w-5xl mx-auto mt-8 p-4 animate-fade-in">
                    <div className="text-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center justify-center gap-2">
                            <Icon path={Icons.Eye}/> Xem trước Đề thi
                        </h2>
                        <p className="text-gray-500 text-sm">Đây là nội dung chính xác sẽ xuất hiện trong file Word.</p>
                    </div>
                    
                    <div className="preview-container">
                        <div className="preview-page">
                            <div dangerouslySetInnerHTML={{__html: content.body + '<hr style="margin: 20px 0; border-top: 1px dashed #999;">' + content.keys}} />
                        </div>
                    </div>
                </div>
            );
        };

        // --- STEP 6: EXPORT (Modified) ---
        const Step6Export = ({ formData, examContent }) => {
            const handleDownload = () => {
                if (!examContent || !examContent.body) return alert("Vui lòng quay lại bước Xem trước để tạo dữ liệu!");
                
                const cssReset = `<style>@page{size:A4;margin:1in;}body{font-family:'Times New Roman',serif;font-size:12pt;line-height:1.2;}p,div{margin:0;padding:0;}table{width:100%;border-collapse:collapse;}</style>`;
                const finalHtml = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'>${cssReset}</head><body>${examContent.body}${examContent.keys}</body></html>`;
                
                const blob = new Blob(['\ufeff', finalHtml], { type: 'application/msword' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `De_Thi_${formData.grade}_${formData.examName.replace(/\s/g,'_')}.doc`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="max-w-4xl mx-auto mt-8 p-4 animate-fade-in text-center">
                    <div className="bg-white p-8 rounded-xl shadow-lg border">
                        <Icon path={Icons.CheckCircle2} />
                        <h2 className="text-2xl font-bold mb-2 mt-4">Hồ sơ đã sẵn sàng!</h2>
                        <p className="text-gray-500 mb-6">Bạn đã kiểm tra kỹ nội dung ở bước trước.</p>
                        <button onClick={handleDownload} className="bg-[#005CA9] text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-blue-700 transition flex items-center gap-2 mx-auto mt-6">
                            <Icon path={Icons.Download} /> TẢI VỀ FILE WORD (.DOC)
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentStep, setCurrentStep] = useState(1);
            // State để lưu nội dung đề thi đã sinh ra ở bước Preview (để đồng bộ với Export)
            const [generatedExamContent, setGeneratedExamContent] = useState(null);

            const [formData, setFormData] = useState(() => {
                try { return JSON.parse(localStorage.getItem('gs_formData')) || { schoolName: 'THCS Nguyễn Du', grade: 'Lớp 8', year: '2025 - 2026', examName: 'Kiểm tra Cuối kì I', examNumber: '1' }; } catch(e){ return { schoolName: 'THCS Nguyễn Du', grade: 'Lớp 8', year: '2025 - 2026', examName: 'Kiểm tra Cuối kì I', examNumber: '1' }; }
            });
            const [selectedUnits, setSelectedUnits] = useState(() => {
                try { return JSON.parse(localStorage.getItem('gs_selectedUnits')) || ['8-1', '8-2', '8-3']; } catch(e){ return ['8-1']; }
            });

            useEffect(() => { localStorage.setItem('gs_formData', JSON.stringify(formData)); }, [formData]);
            useEffect(() => { localStorage.setItem('gs_selectedUnits', JSON.stringify(selectedUnits)); }, [selectedUnits]);

            const steps = [
                { id: 1, title: 'Thông tin', icon: Icons.Info },
                { id: 2, title: 'Nội dung', icon: Icons.BookOpen },
                { id: 3, title: 'Cấu trúc', icon: Icons.Settings },
                { id: 4, title: 'Ma trận', icon: Icons.Grid3X3 },
                { id: 5, title: 'Xem trước', icon: Icons.Eye }, // Bước mới
                { id: 6, title: 'Xuất file', icon: Icons.Download },
            ];

            return (
                <div className="min-h-screen pb-24 relative">
                    <Header />
                    <div className="py-6 px-4 bg-white border-b shadow-sm sticky top-[72px] z-40">
                        <div className="max-w-5xl mx-auto flex justify-between">
                             {steps.map(s => (
                                 <div key={s.id} className={`flex flex-col items-center ${currentStep === s.id ? 'text-[#005CA9] font-bold' : 'text-gray-400'}`}>
                                     <div className="w-8 h-8 rounded-full border flex items-center justify-center mb-1 bg-white">{s.id}</div>
                                     <div className="text-xs hidden md:block">{s.title}</div>
                                 </div>
                             ))}
                        </div>
                    </div>
                    
                    <main>
                        {currentStep === 1 && <Step1Info data={formData} onChange={(k,v) => setFormData({...formData, [k]:v})} />}
                        {currentStep === 2 && <Step2Topics grade={formData.grade} selectedUnits={selectedUnits} onToggleUnit={(id) => setSelectedUnits(prev => prev.includes(id)?prev.filter(x=>x!==id):[...prev, id])} />}
                        {currentStep === 3 && <Step3Config grade={formData.grade} />}
                        {currentStep === 4 && <Step4Matrix grade={formData.grade} />}
                        {/* Bước 5: Xem trước - Truyền hàm callback để lưu nội dung */}
                        {currentStep === 5 && <Step5Preview formData={formData} selectedUnits={selectedUnits} grade={formData.grade} onContentGenerated={setGeneratedExamContent} />}
                        {/* Bước 6: Xuất file - Dùng lại nội dung đã lưu */}
                        {currentStep === 6 && <Step6Export formData={formData} examContent={generatedExamContent} />}
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-2xl z-50">
                        <div className="max-w-5xl mx-auto flex justify-between items-center">
                            <button onClick={() => setCurrentStep(c => Math.max(1, c - 1))} disabled={currentStep === 1} className="px-6 py-2 border rounded hover:bg-gray-50">Quay lại</button>
                            <button onClick={() => setCurrentStep(c => Math.min(6, c + 1))} disabled={currentStep === 6} className="px-6 py-2 bg-[#005CA9] text-white rounded hover:bg-blue-700">Tiếp theo</button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>